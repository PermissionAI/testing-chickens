<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Hell Yeah v2</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
  <style>
:root {
  /* primary teal for accessible contrast */
  --color-primary: #0F766E;
}

body {
  font-family: 'Roboto', Arial, sans-serif;
  margin: 20px auto;
  max-width: 960px;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

.scene-final {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  aspect-ratio: 16 / 9;
  max-width: 960px;
  margin: 0 auto;
}

*[tabindex]:focus-visible,
input[type="file"]:focus-visible {
  outline: 0.125rem solid #115E59;
  outline-offset: 0.125rem;
}

.container-medium,
.container-large {
  margin-right: auto !important;
  margin-left: auto !important;
}

.margin-0 {
  margin: 0rem !important;
}

.padding-0 {
  padding: 0rem !important;
}
.hidden {
  display: none;
}
#chatLog,
#brandLog,
#offerLog {
  border: 1px solid #ccc;
  padding: 10px;
  height: 266px;
  overflow-y: auto;
  margin-bottom: 10px;
}
#chat,
#brandChat,
#offerChat,
.floating-chat {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 320px;
  max-width: 90%;
  background: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-size: 14px;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--color-primary);
  color: #fff;
  padding: 6px 10px;
  cursor: pointer;
}

.chat-header button {
  background: transparent;
  border: none;
  color: inherit;
  font-size: 16px;
  cursor: pointer;
}
.tile {
  border: 1px solid #ccc;
  padding: 10px;
  width: 200px;
  margin-bottom: 20px;
}
#chatLog,
#brandLog,
#offerLog {
  display: flex;
  flex-direction: column;
}


.button {
  background: var(--color-primary);
  color: #FFFFFF;
  border-radius: 8px;
  padding: 16px 32px;
  border: none;
  cursor: pointer;
}

/* keep chat buttons compact */
.chat-box .button {
  padding: 12px 24px;
}

/* larger CTAs used inside modals */
.modal-cta {
  padding: 20px 40px;
}

/* additional spacing for wizard modal buttons in Scene 2 */
#wizardModal .modal-cta {
  margin: 20px;
  padding: 24px 48px;
}

.button:hover {
  background: #115E59;
}

.text-align-center {
  text-align: center;
}

.heading-style-h4 {
  font-size: 24px;
}

.text-size-medium {
  font-size: 16px;
}

.card {
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  padding: 20px;
}

.card:hover {
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.chat-open {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.scene-next {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
}

.preview-ad {
  margin: 0 auto;
}

.border-radius-md {
  border-radius: 12px;
}

.image-responsive {
  width: 100%;
  height: auto;
}

.social_link-icon {
  width: 24px;
  height: 24px;
  margin-right: 8px;
}

.nav-link {
  color: #FFFFFF;
}

.nav-link:hover {
  text-decoration: underline;
}

.modal-overlay {
  background: rgba(0, 0, 0, 0.6);
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-overlay.hidden {
  display: none;
}


.modal-content {
  background: #FFFFFF;
  border-radius: 16px;
  padding: 32px;
}

.footer-links {
  display: flex;
  flex-direction: column;
}

.footer-link {
  color: #6B7280;
  text-decoration: none;
}

.footer-link:hover {
  color: var(--color-primary);
}

.chat-box {
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  height: 400px;
}

.callout {
  font-size: 14px;
  color: var(--color-primary);
  margin-bottom: 8px;
  font-weight: bold;
}

.reward-badge {
  background: #D2B48C;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
  font-weight: bold;
}

.ai,
.user {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 75%;
  line-height: 1.4;
}

.ai {
  background: #f1f0f0;
  align-self: flex-start;
}

.user {
  background: #dcf8c6;
  align-self: flex-end;
}


.step { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }

.placeholder-img {
  width: 100%;
  height: auto;
  margin-bottom: 10px;
  display: block;
  border-radius: 8px;
}

/* Wrap-up scene styles */
#wrapUpScene {
  margin-top: 20px;
}

.brand-tiles {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}


.dashboard-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  font-size: 14px;
}
.dashboard-table th,
.dashboard-table td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: left;
}
.dashboard-table th {
  background: var(--color-primary);
  color: #fff;
}
.dashboard-table tr:nth-child(even) {
  background: #fafafa;
}
.score-high { color: #15803d; font-weight: bold; }

.dashboard-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.user-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 600px) {
  .user-grid { grid-template-columns: 1fr 1fr; }
}

.user-card {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-card .channel-tags { margin-top: 6px; }
.user-card .status { font-weight: bold; }

.chart-placeholder {
  height: 150px;
  border-radius: 8px;
  background: repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 10px,#f3f4f6 10px,#f3f4f6 20px);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6b7280;
  margin-bottom: 20px;
}

.bar {display:flex;align-items:center;margin:4px 0;font-size:12px;gap:4px;}
.bar-inner{height:8px;background:var(--color-primary);border-radius:4px;flex-grow:1;}

.empty-state {
  text-align: center;
  padding: 40px 0;
  color: #666;
}

.detail-panel {
  max-width: 400px;
  width: 90%;
  background: #fff;
  border: 1px solid #ccc;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.tag {
  display: inline-block;
  padding: 2px 6px;
  margin-right: 4px;
  border-radius: 4px;
  font-size: 12px;
  background: #eef;
}
.tag.email { background:#e0f7fa; }
.tag.sms { background:#fce4ec; }
.tag.wallet { background:#e8f5e9; }

.stat {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px 20px;
}

.overlay-text {
  font-size: 20px;
  font-weight: bold;
  margin: 10px 0;
}

#audienceInput {
  width: 100%;
  box-sizing: border-box;
}

.budget-label {
  position: absolute;
  top: 10px;
  right: 20px;
  font-weight: bold;
}

#dataList {
  list-style: none;
  padding-left: 0;
}

#dataList li {
  margin: 4px 0;
}

#branding {
  margin-top: 20px;
}

/* Intro and transition styles */
.intro {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 300px;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.intro h1 {
  animation: fadeInUp 1s ease forwards;
}

.fade {
  transition: opacity 0.5s ease;
}

.fade-hidden {
  opacity: 0;
}

</style>
</head>
<body class="container-medium text-align-center">
<h1>Project Hell Yeah Demo v2</h1>
<h2 id="sceneTitle"></h2>
<div id="introSection">
  <p>Zero party data meets trusted AI. Click Next to begin.</p>
</div>
<div id="userSection" class="hidden">
  <h2>Permission Marketplace</h2>
  <div id="landing" class="container-medium">
    <h3>Featured Offer</h3>
    <div class="tile card">
      <p id="featuredBrand"></p>
      <p class="callout">Exclusive Deals</p>
      <button id="optInBtn" class="button">Opt-In</button>
    </div>
  </div>
  <div id="chat" class="hidden chat-box">
    <div class="chat-header">
      <span>Chat</span>
      <button id="minChatBtn">&#8211;</button>
    </div>
    <div id="chatLog" class="chat-box" role="log" aria-live="polite"></div>
    <button id="nextBtn" class="button">Next</button>
  </div>
  <div id="incomeModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>Income Verification</h2>
      <p>This is a placeholder for a secure third-party verification flow.</p>
      <button id="verifyCompleteBtn" class="button modal-cta">Complete Verification</button>
    </div>
  </div>
  <button id="sceneNextBtn" class="button scene-next hidden">Next</button>
</div>
  <div id="brandSection" class="hidden">
  <h2>Permission Brand Portal</h2>
  <div id="brandChat" class="chat-box">
    <div class="chat-header">
      <span>Chat</span>
      <button id="brandMinChat">&#8211;</button>
    </div>
    <div id="brandLog" class="chat-box" role="log" aria-live="polite"></div>
    
    <button id="brandNextBtn" class="button">Next</button>
  </div>
  <button id="brandOpenChat" class="button chat-open hidden">Chat</button>
    <div id="wizardModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div id="askBudget" class="budget-label">Budget: <span id="budgetAmount">5000 ASK</span></div>
        <div id="wizard" class="container-medium">
          <div id="step1" class="step">
            <h3>Audience & Offer</h3>
            <label for="audienceInput">Audience description</label>
            <textarea id="audienceInput" rows="3">New parents. Ideally household income over 100k. First-time families.</textarea><br>
            <button id="step1Next" class="button modal-cta">Next</button>
          </div>
        <div id="step2" class="step hidden">
          <h3>Creative Setup</h3>
          <img id="creativeImg" class="placeholder-img" src="https://placehold.co/300x150?text=Ad+Preview" alt="Ad creative preview">
          <p><strong>Headline:</strong> <span id="adHeadline"></span></p>
          <p><strong>Body:</strong> <span id="adCopy"></span></p>
          <label>Format:
            <select id="formatSelect">
              <option>Square</option>
              <option>Vertical</option>
              <option>Horizontal</option>
            </select>
          </label><br>
          <button id="step2Next" class="button modal-cta">Next</button>
        </div>
        <div id="step3" class="step hidden">
          <h3>Preview & Launch</h3>
          <div class="tile card preview-ad">
            <h4 id="previewHeadline"></h4>
            <p id="previewBody"></p>
          </div>
          <button id="launchBtn" class="button modal-cta">Launch Campaign</button>
        </div>
      </div>
    </div>
  </div>  </div>
</div>
<div id="offerSection" class="hidden">
  <h2>Permission Marketplace</h2>
  <div id="offerChat" class="chat-box">
    <div class="chat-header">
      <span>Chat</span>
      <button id="offerMinChat">&#8211;</button>
    </div>
    <div id="offerLog" class="chat-box" role="log" aria-live="polite"></div>
    <button id="offerNextBtn" class="button hidden">Next</button>
  </div>
  <button id="offerOpenChat" class="button chat-open hidden">Chat</button>
</div>
<div id="finalSection" class="hidden container-medium">
  <h2>Automation Dashboard</h2>
  <div id="chartPlaceholder" class="chart-placeholder">Chart Placeholder</div>
  <div id="filterBar" class="dashboard-filters">
    <select id="channelFilter">
      <option value="">All Channels</option>
      <option value="email">&#128231; Email</option>
      <option value="sms">&#128241; SMS</option>
      <option value="wallet">&#128091; In-wallet</option>
    </select>
    <select id="statusFilter">
      <option value="">All Statuses</option>
      <option value="active">Active</option>
      <option value="paused">Paused</option>
      <option value="completed">Completed</option>
    </select>
    <select id="rangeFilter">
      <option value="7">Last 7 days</option>
      <option value="30" selected>Last 30 days</option>
      <option value="90">Last 90 days</option>
    </select>
  </div>
  <div id="userGrid" class="user-grid"></div>
    <div id="detailPanel" class="modal-overlay hidden" role="dialog" aria-modal="true">
      <div class="modal-content detail-panel">
        <h3>User Timeline</h3>
        <ul id="timeline"></ul>
        <h3>Available Data</h3>
        <ul id="dataList"></ul>
        <button id="closeDetail" class="button">Close</button>
      </div>
    </div>
  <button id="dashboardNextBtn" class="button scene-next">Next</button>
</div>
<div id="brandingSection" class="hidden container-medium">
  <p class="overlay-text">Permission x Google</p>
  <p class="overlay-text">Zero-party data. Trusted by users. Powered by AI.</p>
  <button id="restartBtn" class="button">Replay Demo</button>
</div>
<button id="mainNext" class="button scene-next">Next</button>
<script>
function q(id){return document.getElementById(id);}

const scenes=[
  {id:'introSection',title:'Intro'},
  {id:'userSection',title:'Scene 1 - User Onboarding'},
  {id:'brandSection',title:'Scene 2 - Brand Portal'},
  {id:'offerSection',title:'Scene 3 - Offer Notification'},
  {id:'finalSection',title:'Scene 4 - Data Dashboard'},
  {id:'brandingSection',title:'Scene 5 - Wrap Up'}
];
let sceneIndex=0;
let userActionBtn=null;
let brandActionBtn=null;
const dashNextBtn=q('dashboardNextBtn');

// ----- Automation Dashboard Data -----
const automationUsers=[
  {
    id:'U1001',country:'US',source:'Website',join:'2024-04-01',score:92,
    automations:[
      {channel:'email',status:'active',time:'2024-05-23 12:00'},
      {channel:'sms',status:'active',time:'2024-05-22 09:00'}
    ]
  },
  {
    id:'U1002',country:'CA',source:'Referral',join:'2024-03-15',score:80,
    automations:[
      {channel:'wallet',status:'paused',time:'2024-05-18 14:30'}
    ]
  },
  {
    id:'U1003',country:'GB',source:'Ad',join:'2024-02-20',score:70,
    automations:[
      {channel:'email',status:'completed',time:'2024-05-10 08:00'}
    ]
  },
  {
    id:'U1004',country:'US',source:'Website',join:'2024-03-22',score:78,
    automations:[
      {channel:'sms',status:'active',time:'2024-05-25 13:10'}
    ]
  },
  {
    id:'U1005',country:'DE',source:'Referral',join:'2024-04-15',score:84,
    automations:[
      {channel:'wallet',status:'completed',time:'2024-05-20 15:40'}
    ]
  },
  {
    id:'U1006',country:'FR',source:'Ad',join:'2024-05-01',score:68,
    automations:[
      {channel:'email',status:'active',time:'2024-05-28 09:20'}
    ]
  }
];

const icons={email:'\uD83D\uDCE7',sms:'\uD83D\uDCF1',wallet:'\uD83D\uDC91'};
function icon(c){return icons[c]||'';}

function lastTrigger(autos){
  return autos.reduce((a,b)=>a>b.time?a:b.time,'');
}

function renderChart(){
  const counts={email:0,sms:0,wallet:0};
  automationUsers.forEach(u=>{
    u.automations.forEach(a=>{if(a.status==='active') counts[a.channel] = (counts[a.channel]||0)+1;});
  });
  const total=counts.email+counts.sms+counts.wallet||1;
  const chart=q('chartPlaceholder');
  if(!chart) return;
  chart.innerHTML=['email','sms','wallet'].map(c=>{
    const pct=Math.round(counts[c]/total*100);
    return `<div class="bar"><span>${icon(c)}</span><div class="bar-inner" style="width:${pct}%"></div></div>`;
  }).join('');
}

function renderUsers(){
  const grid=q('userGrid');
  grid.innerHTML='';
  const chan=q('channelFilter').value;
  const status=q('statusFilter').value;
  let count=0;
  automationUsers.forEach((u,idx)=>{
    const hasChan=!chan||u.automations.some(a=>a.channel===chan);
    const hasStatus=!status||u.automations.some(a=>a.status===status);
    if(!hasChan||!hasStatus) return;
    count++;
    const active=u.automations.filter(a=>a.status==='active').map(a=>a.channel);
    const activeTags=active.map(c=>`<span class="tag ${c}">${icon(c)} ${c}</span>`).join(' ');
    const card=document.createElement('div');
    card.className='user-card';
    card.dataset.index=idx;
    card.innerHTML=`<div><strong>${u.id}</strong></div>
    <div class="meta">Score: <span class="score-high">${u.score}</span></div>
    <div class="channel-tags">${activeTags||'<em>No active automations</em>'}</div>`;
    grid.appendChild(card);
  });
  if(count===0){
    grid.innerHTML='<p class="empty-state">No automations found</p>';
  }
}

function showDetail(user){
  const panel=q('detailPanel');
  const list=q('timeline');
  const dataList=q('dataList');
  list.innerHTML='';
  dataList.innerHTML='';
  user.automations.forEach(a=>{
    const li=document.createElement('li');
    li.textContent=`${a.time}: ${a.channel} - ${a.status}`;
    list.appendChild(li);
  });
  const available=[
    {name:'Social Data',ask:50},
    {name:'Behavioral Data',ask:75},
    {name:'Protected PII',ask:200}
  ];
  available.forEach(d=>{
    const li=document.createElement('li');
    li.textContent=`${d.name} - ${d.ask} ASK`;
    dataList.appendChild(li);
  });
  panel.classList.remove('hidden');
}

function hideNext(){ q('nextBtn').classList.add('hidden'); }
function showNext(){ q('nextBtn').classList.remove('hidden'); }
function hideBrandNext(){ q('brandNextBtn').classList.add('hidden'); }
function showBrandNext(){ q('brandNextBtn').classList.remove('hidden'); }

function parseAsk(str){
  const m=/(\d+)\s*ASK/i.exec(str||'');
  return m?parseInt(m[1],10):0;
}

function updateWrapUp(){
  const offers=JSON.parse(localStorage.getItem('offers')||'[]');
  if(offers.length){
    const last=offers[offers.length-1];
    if(q('recentActivity')) q('recentActivity').textContent='Reward accepted: '+last.reward;
  }
}

function showWrapUp(){
  if(q('chat')) q('chat').classList.add('hidden');
  if(q('brandChat')) q('brandChat').classList.add('hidden');
  if(q('brandOpenChat')) q('brandOpenChat').classList.add('hidden');
  if(q('offerChat')) q('offerChat').classList.add('hidden');
  if(q('offerOpenChat')) q('offerOpenChat').classList.add('hidden');
  updateWrapUp();
  showScene(4);
}

function showScene(i){
  scenes.forEach((s,idx)=>{
    const el=q(s.id);
    if(el) el.classList.toggle('hidden',idx!==i);
  });
  sceneIndex=i;
  if(q('detailPanel')) q('detailPanel').classList.add('hidden');
  q('sceneTitle').textContent=scenes[i].title;
  if(i===1) showNext(); else hideNext();
  if(i===2){
    showBrandNext();
    if(bPair===0) { appendBrand(brandConv[0].ai,'ai'); bExpect='user'; }
  } else {
    hideBrandNext();
  }
  if(i===3){
    startOffer();
  }
  if(i===4){
    updateWrapUp();
    renderChart();
    renderUsers();
  }
  if(i===4||i===5){
    document.body.classList.add('scene-final');
  } else {
    document.body.classList.remove('scene-final');
  }
  if(i===0) q('mainNext').classList.remove('hidden');
  else q('mainNext').classList.add('hidden');
}

q('mainNext').onclick=()=>{
  if(sceneIndex<scenes.length-1){
    showScene(sceneIndex+1);
  }else{
    showScene(0);
  }
};

// ----- User Onboarding -----
const featuredBrand='Diaper Brand #1';
const userConv=[
  {ai:`Welcome back, your data has earned you 1250 ASK since your last session, thanks for opting in to ${featuredBrand}! Have you ever bought from them before?`,user:"Not yet â€” just found out I'm expecting our first."},
  {ai:"Omg, congrats! Anything you're nervous about?",user:"Everything. Budget's tight."},
  {ai:"You can verify your income to unlock personalized offers. Want to try?",user:null}
];
let uPair=0; let expecting='ai';

function appendChat(msg,cls){
  const p=document.createElement('p');
  p.textContent=msg;
  if(cls) p.className=cls;
  q('chatLog').appendChild(p);
  q('chatLog').scrollTop=q('chatLog').scrollHeight;
}

function showVerify(){
  hideNext();
  if(userActionBtn) userActionBtn.remove();
  const btn=document.createElement('button');
  btn.className='button';
  btn.textContent='Verify Now';
  btn.onclick=()=>{q('incomeModal').classList.remove('hidden');};
  q('chatLog').appendChild(btn);
  userActionBtn=btn;
}

function userNext(){
  if(uPair>=userConv.length){
    hideNext();
    return;
  }
  const curr=userConv[uPair];
  if(expecting==='user'){
    if(curr.user){
      appendChat(curr.user,'user');
      uPair++; expecting='ai';
    }else{
      showVerify();
      uPair++; // wait for verify button
    }
  }else{
    appendChat(curr.ai,'ai');
    expecting='user';
  }
}

q('optInBtn').onclick=()=>{
  q('landing').classList.add('hidden');
  q('chat').classList.remove('hidden');
  q('featuredBrand').textContent=featuredBrand;
  const brands=JSON.parse(localStorage.getItem('optedInBrands')||'[]');
  if(!brands.includes(featuredBrand)){
    brands.push(featuredBrand);
    localStorage.setItem('optedInBrands',JSON.stringify(brands));
  }
  showNext();
  userNext();
};

q('nextBtn').onclick=userNext;
q('verifyCompleteBtn').onclick=()=>{
  q('incomeModal').classList.add('hidden');
  appendChat('Income verified!','ai');
  if(userActionBtn){userActionBtn.remove();userActionBtn=null;}
  hideNext();
  q('sceneNextBtn').classList.remove('hidden');
};
q('sceneNextBtn').onclick=()=>showScene(2);

// ----- Brand Portal -----
const params = new URLSearchParams(window.location.search);
const demo = params.get('demo');

const brandNames = ['Bambino Diapers','Happy Tush','SnugBug','EcoBaby','SoftCare'];
const brand = brandNames[Math.floor(Math.random()*brandNames.length)];
let bPair = 0;
let bExpect = 'user';
const brandConv = [
  { ai: 'Welcome back. Who are you hoping to connect with today?',
    user: 'New parents. Ideally household income over 100k. First-time families.' },
  { ai: 'Got it. Let\u2019s build your audience. We\u2019ll use Google targeting + Permission signals. Want to include your CRM list?',
    user: null },
  { ai: 'Want to reach families already on Permission too? You can offer them a reward to join you.',
    user: 'Yes \u2014 let\u2019s offer 800 ASK + $5 off.' }
];

function appendBrand(msg, cls){
  const p = document.createElement('p');
  p.textContent = msg;
  if(cls) p.className = cls;
  q('brandLog').appendChild(p);
  q('brandLog').scrollTop = q('brandLog').scrollHeight;
}

function showWizard(){
  q('wizardModal').classList.remove('hidden');
}

function showWizardButton(){
  hideBrandNext();
  if(brandActionBtn) brandActionBtn.remove();
  const btn = document.createElement('button');
  btn.className = 'button';
  btn.textContent = 'Open Builder';
  btn.onclick = () => {
    btn.remove();
    brandActionBtn = null;
    showWizard();
    bPair++;
    bExpect = 'ai';
  };
  brandActionBtn = btn;
  q('brandLog').appendChild(btn);
}

function handleBrandNext(){
  if(bPair >= brandConv.length){
    hideBrandNext();
    return;
  }
  const curr = brandConv[bPair];
  if(bExpect === 'user'){
    if(curr.user){
      appendBrand(curr.user, 'user');
      bPair++;
      if(bPair === brandConv.length){
        hideBrandNext();
        showOfferSummary(curr.user);
      }
      bExpect = 'ai';
    } else {
      // waiting for wizard button
    }
  } else {
    appendBrand(curr.ai, 'ai');
    bExpect = 'user';
    if(bPair === 1){
      showWizardButton();
    }
  }
}

function generateCreative(){
  const head = 'Welcome New Parents!';
  const body = 'Save on essentials for your growing family with ' + brand + '.';
  q('adHeadline').textContent = head;
  q('adCopy').textContent = body;
  q('previewHeadline').textContent = head;
  q('previewBody').textContent = body;
}

q('step1Next').onclick = () => {
  q('step1').classList.add('hidden');
  generateCreative();
  q('step2').classList.remove('hidden');
  handleBrandNext();
};

q('step2Next').onclick = () => {
  q('step2').classList.add('hidden');
  q('step3').classList.remove('hidden');
};

q('launchBtn').onclick = () => {
  q('step3').classList.add('hidden');
  q('wizardModal').classList.add('hidden');
  hideBrandNext();
  handleBrandNext();
};

function showOfferSummary(txt){
  const btn=q('brandNextBtn');
  btn.onclick=null;
  const lines=[
    {cls:'ai',msg:'Good idea, adding a coupon. Can I increase your reward for a good fit?'},
    {cls:'user',msg:'Yes. We can go up to 2500 ASK for a verified match with our targeting.'},
    {cls:'ai',msg:'Perfect. Click below to go live.'}
  ];
  let idx=0;
  function next(){
    appendBrand(lines[idx].msg,lines[idx].cls);
    idx++;
    if(idx===lines.length){
      btn.onclick=null;
      hideBrandNext();
      const reward='2500 ASK + $5 off';
      const go=document.createElement('button');
      go.className='button';
      go.textContent='Go Live';
      go.onclick=()=>{
        const offers=JSON.parse(localStorage.getItem('offers')||'[]');
        offers.push({brand:brand,reward:reward});
        localStorage.setItem('offers',JSON.stringify(offers));
        const done=document.createElement('p');
        done.className='ai';
        done.textContent='Campaign live!';
        q('brandLog').appendChild(done);
        const nextBtn=document.createElement('button');
        nextBtn.className='button scene-next';
        nextBtn.textContent='Next';
        nextBtn.onclick=()=>{showScene(3);};
        q('brandLog').appendChild(nextBtn);
        q('brandLog').scrollTop=q('brandLog').scrollHeight;
      };
      q('brandLog').appendChild(go);
      q('brandLog').scrollTop=q('brandLog').scrollHeight;
    }
  }
  btn.onclick=next;
  showBrandNext();
  next();
}

q('brandNextBtn').onclick = handleBrandNext;

if(q('brandMinChat')){
  q('brandMinChat').onclick = () => {
    q('brandChat').classList.add('hidden');
    if(q('brandOpenChat')) q('brandOpenChat').classList.remove('hidden');
  };
}

if(q('brandOpenChat')){
  q('brandOpenChat').onclick = () => {
    q('brandChat').classList.remove('hidden');
    q('brandOpenChat').classList.add('hidden');
  };
}

// ----- Offer Notification -----
let offerIdx = 0;
const offerMsgs = [
  'Hey, just got some good news \u2014',
  'Diaper Brand 2 launched a new offer made for new parents like you.',
  'You\u2019ve unlocked a special bonus from them \u2014 2500 ASK + $5 off \u2014 because you seem like a perfect match. Want to join?'
];

function hideOfferNext(){ q('offerNextBtn').classList.add('hidden'); }
function showOfferNext(){ q('offerNextBtn').classList.remove('hidden'); }

function offerNext(){
  if(offerIdx < offerMsgs.length){
    const p=document.createElement('p');
    p.className='ai';
    p.textContent=offerMsgs[offerIdx];
    q('offerLog').appendChild(p);
    q('offerLog').scrollTop=q('offerLog').scrollHeight;
    offerIdx++;
    if(offerIdx===offerMsgs.length){
      hideOfferNext();
      showJoinOffer();
    }
  }
}

function displayOfferSequence(arr, done){
  let i=0;
  function next(){
    if(i<arr.length){
      const el=document.createElement('p');
      el.className='ai';
      el.textContent=arr[i];
      q('offerLog').appendChild(el);
      q('offerLog').scrollTop=q('offerLog').scrollHeight;
      i++;
      next();
    }else if(done){
      done();
    }
  }
  next();
}

function showJoinOffer(){
  const btn = document.createElement('button');
  btn.className = 'button';
  btn.textContent = 'Join Offer';
  btn.onclick = () => {
    btn.remove();
    displayOfferSequence([
      "Nice. You're all set.",
      "Oh btw \u2014 have you looked into baby food subscriptions yet? I know a brand that has big rewards for someone like you."
    ], () => { showOfferNext(); });
  };
  q('offerLog').appendChild(btn);
}

function startOffer(){
  hideOfferNext();
  q('offerLog').innerHTML = '';
  offerIdx = 0;
  q('offerChat').classList.remove('hidden');
  if(q('offerOpenChat')) q('offerOpenChat').classList.add('hidden');
  offerNext();
  showOfferNext();
}

q('offerNextBtn').onclick = () => {
  if(offerIdx < offerMsgs.length){
    offerNext();
  } else {
    showScene(4);
  }
};

if(q('offerMinChat')){
  q('offerMinChat').onclick = () => {
    q('offerChat').classList.add('hidden');
    if(q('offerOpenChat')) q('offerOpenChat').classList.remove('hidden');
  };
}

if(q('offerOpenChat')){
  q('offerOpenChat').onclick = () => {
    q('offerChat').classList.remove('hidden');
    q('offerOpenChat').classList.add('hidden');
  };
}

// ----- Automation Dashboard Events -----
if(q('closeDetail')) q('closeDetail').onclick=()=>q('detailPanel').classList.add('hidden');
if(q('userGrid')){
  q('userGrid').onclick=e=>{
    const card=e.target.closest('.user-card');
    if(card) showDetail(automationUsers[card.dataset.index]);
  };
}
['channelFilter','statusFilter','rangeFilter'].forEach(id=>{
  if(q(id)) q(id).onchange=renderUsers;
});

if(dashNextBtn){
  dashNextBtn.onclick=()=>showScene(5);
}

function resetDemo(){
  sessionStorage.clear();
  localStorage.removeItem('offers');
  localStorage.removeItem('optedInBrands');
  location.reload();
}

q('restartBtn').onclick=resetDemo;

window.onload=()=>{
  if(!localStorage.getItem('offers')){
    localStorage.setItem('offers', JSON.stringify([
      {brand:'EcoBaby', reward:'500 ASK + $5 off'},
      {brand:'Happy Tush', reward:'250 ASK + 10% off'}
    ]));
  }
  if(!localStorage.getItem('optedInBrands')){
    localStorage.setItem('optedInBrands', JSON.stringify(['EcoBaby','Happy Tush']));
  }
  renderChart();
  renderUsers();
  showScene(0);
};
</script>
</body>
</html>
